name: Sync docs on publish
on:
  release:
    types: [published]

jobs:
  sync-docs:
    name: Sync docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Sync README to target repo
        env:
          GITHUB_TOKEN: ${{ secrets.SYNC_DOCS_TOKEN }}
        run: |
          # Read the README.md content
          README_CONTENT=$(cat packages/mcp-server/README.md)
          
          # Create the complete content with metadata at the top
          cat > /tmp/complete_content.mdx << 'EOF'
          {/* 
            DO NOT EDIT THIS FILE DIRECTLY! 

            It is automatically generated by the publish-sync-docs GitHub Action in
            the moonbanking/moonbanking-node repository.
          */}

          export const metadata = {
            title: `MCP`,
            description: `Create AI agents using Moon Banking's MCP server. Get high-quality data about banks worldwide from your favorite LLM platform with Moon Banking's MCP.`,
          };

          <ApiKeyNote featureName="MCP" />
          
          EOF
          
          # Append the README content
          echo "$README_CONTENT" >> /tmp/complete_content.mdx
          
          # Read the complete content
          COMPLETE_CONTENT=$(cat /tmp/complete_content.mdx)
          
          # Base64 encode the complete content
          ENCODED_CONTENT=$(echo "$COMPLETE_CONTENT" | base64 -w 0)
          
          # Function to create PR for a specific target branch
          create_pr_for_branch() {
            local target_branch=$1
            local pr_branch="sync-mcp-docs-to-$target_branch-$(date +%s)"
            echo "Creating PR for target branch: $target_branch"
            
            # Check if current content differs from target
            CURRENT_FILE_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/getfullup/moonbanking/contents/apps/docs/app/mcp/page.mdx?ref=$target_branch")
            
            if echo "$CURRENT_FILE_RESPONSE" | grep -q '"content"'; then
              # Extract and clean the base64 content (remove newlines and whitespace)
              CURRENT_ENCODED=$(echo "$CURRENT_FILE_RESPONSE" | grep '"content"' | cut -d'"' -f4 | tr -d '\n\r ')
              if [ -n "$CURRENT_ENCODED" ]; then
                CURRENT_CONTENT=$(echo "$CURRENT_ENCODED" | base64 -d 2>/dev/null || echo "")
                if [ "$CURRENT_CONTENT" = "$COMPLETE_CONTENT" ]; then
                  echo "Content is already up to date for $target_branch, skipping PR creation"
                  return
                fi
              fi
            fi
            
            # Create a new branch from the target branch
            TARGET_SHA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/getfullup/moonbanking/git/refs/heads/$target_branch" | \
              grep '"sha"' | cut -d'"' -f4)
            
            curl -s -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"ref\": \"refs/heads/$pr_branch\", \"sha\": \"$TARGET_SHA\"}" \
              "https://api.github.com/repos/getfullup/moonbanking/git/refs"
            
            # Get the current file SHA from the new branch (if it exists)
            CURRENT_FILE_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/getfullup/moonbanking/contents/apps/docs/app/mcp/page.mdx?ref=$pr_branch")
            
            if echo "$CURRENT_FILE_RESPONSE" | grep -q '"sha"'; then
              CURRENT_SHA=$(echo "$CURRENT_FILE_RESPONSE" | grep '"sha"' | cut -d'"' -f4)
              SHA_PARAM=", \"sha\": \"$CURRENT_SHA\""
            else
              SHA_PARAM=""
            fi
            
            # Update the file in the PR branch
            JSON_PAYLOAD=$(cat <<EOF
          {
            "message": "Sync MCP server docs from moonbanking-node",
            "content": "$ENCODED_CONTENT",
            "branch": "$pr_branch"$SHA_PARAM
          }
          EOF
            )
            
            curl -s -X PUT \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$JSON_PAYLOAD" \
              "https://api.github.com/repos/getfullup/moonbanking/contents/apps/docs/app/mcp/page.mdx"
            
            # Create the pull request
            PR_PAYLOAD=$(cat <<EOF
          {
            "title": "Sync MCP server docs to $target_branch",
            "head": "$pr_branch",
            "base": "$target_branch",
            "body": "This PR syncs the latest MCP server documentation from the moonbanking-node repository.\n\nAuto-generated from release: ${{ github.event.release.tag_name || 'manual trigger' }}"
          }
          EOF
            )
            
            PR_RESPONSE=$(curl -s -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$PR_PAYLOAD" \
              "https://api.github.com/repos/getfullup/moonbanking/pulls")
            
            PR_URL=$(echo "$PR_RESPONSE" | grep '"html_url"' | head -1 | cut -d'"' -f4)
            echo "Created PR for $target_branch: $PR_URL"
          }
          
          # Create PRs for both branches
          create_pr_for_branch "master"
          create_pr_for_branch "preview"